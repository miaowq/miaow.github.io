---
title: 分区器
categories:
  - mq
tags:
  - mq
  - kafka
abbrlink: 6a47e033
date: 2023-12-07 23:00:03
---

> 本系列内容基于 kafka_2.12-2.3.1

本文主要分析了 Kafka 消息分区（Partition）机制的原理，包括常见分区策略以及自定义分区策略。

消息在通过 `send()` 方法发往 `broker` 的过程中，有可能需要经过`拦截器（Interceptor）`、`序列化器（Serializer）`和`分区器（Partitioner）`的一系列作用之后才能被真正地发往 `broker`。

拦截器一般不是必需的，而序列化器是必需的。消息经过序列化之后就需要确定它发往的分区。分区器的作用就是为消息分配分区。

- 如果消息 `kafka.Message` 中指定了 `Partition` 字段，那么就不需要分区器的作用，因为 `Partition` 代表的就是所要发往的分区号。

- 如果没有指定 `Partition` 字段，那么就需要依赖分区器，根据 key 这个字段来计算 `Partition` 的值。

<!-- more -->

# 概述
Kafka 有主题（Topic）的概念，它是承载真实数据的逻辑容器，而在主题之下还分为若干个分区，也就是说 Kafka 的消息组织方式实际上是三级结构：主题 - 分区 - 消息。

主题下的每条消息只会保存在某一个分区中，而不会在多个分区中被保存多份。官网上的这张图非常清晰地展示了 Kafka 的三级结构，如下所示：

![](/images/mq/kafka/kafka8.png)

**你觉得为什么 Kafka 要做这样的设计？为什么使用分区的概念而不是直接使用多个主题呢？**

其实分区的作用就是提供负载均衡的能力，或者说对数据进行分区的主要原因，就是为了实现系统的高伸缩性（Scalability）。

不同的分区能够被放置到不同节点的机器上，而数据的读写操作也都是针对分区这个粒度而进行的，这样每个节点的机器都能独立地执行各自分区的读写请求处理。并且，我们还可以通过添加新的节点机器来增加整体系统的吞吐量。

不同的分布式系统对分区的叫法也不尽相同。比如在 Kafka 中叫分区，在 MongoDB 和 Elasticsearch 中就叫分片 Shard，而在 HBase 中则叫 Region，在 Cassandra 中又被称作 vnode。

> 从表面看起来它们实现原理可能不尽相同，但对底层分区（Partitioning）的整体思想却从未改变。

# 分区策略

所谓分区策略是决定生产者将消息发送到哪个分区的算法。Kafka 为我们提供了默认的分区策略，同时它也支持你自定义分区策略。

## 自定义分区策略

需要自行实现

## 轮询策略

也称 Round-robin 策略，即顺序分配。

> 比如一个主题下有 3 个分区，那么第一条消息被发送到分区 0，第二条被发送到分区 1，第三条被发送到分区 2，以此类推。

![](/images/mq/kafka/kafka9.png)

轮询策略有非常优秀的负载均衡表现，它总是能保证消息最大限度地被平均分配到所有分区上，故默认情况下它是最合理的分区策略，也是我们最常用的分区策略之一。

## 随机策略

也称 Randomness 策略。所谓随机就是我们随意地将消息放置到任意一个分区上，如下面这张图所示。

![](/images/mq/kafka/kafka10.png)

从实际表现来看，它要逊于轮询策略，所以如果追求数据的均匀分布，还是使用轮询策略比较好。

## 按消息键保序策略

也称 Key-ordering 策略。

Kafka 允许为每条消息定义消息键，简称为 Key。这个 Key 的作用非常大，它可以是一个有着明确业务含义的字符串，比如客户代码、部门编号或是业务 ID 等；也可以用来表征消息元数据。

特别是在 Kafka 不支持时间戳的年代，在一些场景中，工程师们都是直接将消息创建时间封装进 Key 里面的。一旦消息被定义了 Key，那么你就可以保证同一个 Key 的所有消息都进入到相同的分区里面，由于每个分区下的消息处理都是有顺序的，故这个策略被称为按消息键保序策略，如下图所示。

![](/images/mq/kafka/kafka11.png)